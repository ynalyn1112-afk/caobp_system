{% extends 'base.html' %}
{% load static %}

{% block title %}Reset Password - AOBP System{% endblock %}

{% block extra_css %}
<style>
    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .reset-container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        overflow: hidden;
        max-width: 450px;
        width: 100%;
        margin: 20px;
    }
    
    .reset-header {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 40px 30px;
        text-align: center;
    }
    
    .reset-header h2 {
        margin: 0;
        font-weight: 700;
    }
    
    .reset-header p {
        margin: 10px 0 0 0;
        opacity: 0.9;
    }
    
    .reset-body {
        padding: 40px 30px;
    }
    
    .form-floating {
        margin-bottom: 20px;
    }
    
    .form-floating input {
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 15px;
        transition: all 0.3s ease;
    }
    
    .form-floating input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    
    .password-strength {
        margin-top: 10px;
        font-size: 0.875rem;
    }
    
    .strength-bar {
        height: 4px;
        background: #e9ecef;
        border-radius: 2px;
        overflow: hidden;
        margin-top: 5px;
    }
    
    .strength-fill {
        height: 100%;
        transition: all 0.3s ease;
        border-radius: 2px;
    }
    
    .strength-weak { background: #dc3545; width: 25%; }
    .strength-fair { background: #ffc107; width: 50%; }
    .strength-good { background: #17a2b8; width: 75%; }
    .strength-strong { background: #28a745; width: 100%; }
    
    .strength-text {
        font-weight: 600;
        margin-top: 5px;
    }
    
    .strength-weak { color: #dc3545; }
    .strength-fair { color: #ffc107; }
    .strength-good { color: #17a2b8; }
    .strength-strong { color: #28a745; }
    
    .btn-reset {
        background: linear-gradient(135deg, #667eea, #764ba2);
        border: none;
        border-radius: 10px;
        padding: 15px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: all 0.3s ease;
        width: 100%;
    }
    
    .btn-reset:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
    }
    
    .btn-reset:disabled {
        opacity: 0.6;
        transform: none;
        box-shadow: none;
    }
    
    .back-to-verify {
        text-align: center;
        margin-top: 20px;
    }
    
    .back-to-verify a {
        color: #667eea;
        text-decoration: none;
        font-weight: 500;
        transition: color 0.3s ease;
    }
    
    .back-to-verify a:hover {
        color: #764ba2;
    }
    
    .back-to-home {
        position: absolute;
        top: 20px;
        left: 20px;
        color: white;
        text-decoration: none;
        font-weight: 500;
        transition: opacity 0.3s ease;
    }
    
    .back-to-home:hover {
        color: white;
        opacity: 0.8;
    }
    
    .loading-spinner {
        display: none;
        width: 20px;
        height: 20px;
        border: 2px solid #ffffff;
        border-top: 2px solid transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .info-box {
        background: #e8f5e8;
        border: 1px solid #c8e6c9;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .info-box i {
        color: #4caf50;
        margin-right: 10px;
    }
    
    .password-requirements {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        font-size: 0.875rem;
    }
    
    .requirement {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
    }
    
    .requirement i {
        margin-right: 8px;
        width: 16px;
    }
    
    .requirement.valid i {
        color: #28a745;
    }
    
    .requirement.invalid i {
        color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<a href="{% url 'landing_page' %}" class="back-to-home">
    <i class="bi bi-arrow-left me-2"></i>Back to Home
</a>

<div class="reset-container">
    <div class="reset-header">
        <h2><i class="bi bi-key me-2"></i>Reset Password</h2>
        <p>Create a new secure password</p>
    </div>
    
    <div class="reset-body">
        <div class="info-box">
            <i class="bi bi-info-circle"></i>
            <strong>Account:</strong> {{ user.username }}<br>
            <small>Please create a strong password for your account.</small>
        </div>
        
        <div class="password-requirements">
            <strong>Password Requirements:</strong>
            <div class="requirement" id="req-length">
                <i class="bi bi-circle"></i>
                <span>At least 8 characters long</span>
            </div>
            <div class="requirement" id="req-uppercase">
                <i class="bi bi-circle"></i>
                <span>Contains uppercase letter</span>
            </div>
            <div class="requirement" id="req-lowercase">
                <i class="bi bi-circle"></i>
                <span>Contains lowercase letter</span>
            </div>
            <div class="requirement" id="req-number">
                <i class="bi bi-circle"></i>
                <span>Contains number</span>
            </div>
            <div class="requirement" id="req-special">
                <i class="bi bi-circle"></i>
                <span>Contains special character</span>
            </div>
        </div>
        
        <form method="post" id="resetForm">
            {% csrf_token %}
            <input type="hidden" name="code" value="{{ code }}">
            
            <div class="form-floating">
                <input type="password" class="form-control" id="new_password" name="new_password" placeholder="New Password" required>
                <label for="new_password"><i class="bi bi-lock me-2"></i>New Password</label>
                <div class="password-strength">
                    <div class="strength-bar">
                        <div class="strength-fill" id="strengthFill"></div>
                    </div>
                    <div class="strength-text" id="strengthText">Enter a password</div>
                </div>
            </div>
            
            <div class="form-floating">
                <input type="password" class="form-control" id="confirm_password" name="confirm_password" placeholder="Confirm Password" required>
                <label for="confirm_password"><i class="bi bi-lock-fill me-2"></i>Confirm Password</label>
            </div>
            
            <button type="submit" class="btn btn-primary btn-reset" id="resetBtn" disabled>
                <span class="btn-text">
                    <i class="bi bi-check-circle me-2"></i>Reset Password
                </span>
                <div class="loading-spinner"></div>
            </button>
        </form>
        
        <div class="back-to-verify">
            <a href="{% url 'verify_code' user.id %}">
                <i class="bi bi-arrow-left me-2"></i>Back to Verify Code
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const newPasswordInput = document.getElementById('new_password');
    const confirmPasswordInput = document.getElementById('confirm_password');
    const resetBtn = document.getElementById('resetBtn');
    const btnText = resetBtn.querySelector('.btn-text');
    const loadingSpinner = resetBtn.querySelector('.loading-spinner');
    const strengthFill = document.getElementById('strengthFill');
    const strengthText = document.getElementById('strengthText');
    
    // Password strength checker
    newPasswordInput.addEventListener('input', function() {
        const password = this.value;
        const strength = calculatePasswordStrength(password);
        
        // Update strength bar
        strengthFill.className = 'strength-fill ' + strength.class;
        strengthText.textContent = strength.text;
        strengthText.className = 'strength-text ' + strength.class;
        
        // Update requirements
        updateRequirements(password);
        
        // Check if passwords match
        checkPasswordMatch();
    });
    
    confirmPasswordInput.addEventListener('input', checkPasswordMatch);
    
    function calculatePasswordStrength(password) {
        let score = 0;
        let requirements = {
            length: password.length >= 8,
            uppercase: /[A-Z]/.test(password),
            lowercase: /[a-z]/.test(password),
            number: /\d/.test(password),
            special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
        };
        
        // Calculate score
        Object.values(requirements).forEach(met => {
            if (met) score++;
        });
        
        if (password.length === 0) {
            return { class: '', text: 'Enter a password' };
        } else if (score < 2) {
            return { class: 'strength-weak', text: 'Weak password' };
        } else if (score < 4) {
            return { class: 'strength-fair', text: 'Fair password' };
        } else if (score < 5) {
            return { class: 'strength-good', text: 'Good password' };
        } else {
            return { class: 'strength-strong', text: 'Strong password' };
        }
    }
    
    function updateRequirements(password) {
        const requirements = {
            length: password.length >= 8,
            uppercase: /[A-Z]/.test(password),
            lowercase: /[a-z]/.test(password),
            number: /\d/.test(password),
            special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
        };
        
        Object.keys(requirements).forEach(req => {
            const element = document.getElementById('req-' + req);
            const icon = element.querySelector('i');
            
            if (requirements[req]) {
                element.classList.add('valid');
                element.classList.remove('invalid');
                icon.className = 'bi bi-check-circle-fill';
            } else {
                element.classList.add('invalid');
                element.classList.remove('valid');
                icon.className = 'bi bi-circle';
            }
        });
    }
    
    function checkPasswordMatch() {
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        
        if (confirmPassword) {
            if (newPassword === confirmPassword) {
                confirmPasswordInput.style.borderColor = '#28a745';
                resetBtn.disabled = false;
            } else {
                confirmPasswordInput.style.borderColor = '#dc3545';
                resetBtn.disabled = true;
            }
        } else {
            confirmPasswordInput.style.borderColor = '#e9ecef';
            resetBtn.disabled = true;
        }
    }
    
    document.getElementById('resetForm').addEventListener('submit', function(e) {
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        
        if (newPassword !== confirmPassword) {
            e.preventDefault();
            showToast('Passwords do not match!', 'error');
            return;
        }
        
        if (newPassword.length < 8) {
            e.preventDefault();
            showToast('Password must be at least 8 characters long!', 'error');
            return;
        }
        
        // Show loading state
        btnText.style.display = 'none';
        loadingSpinner.style.display = 'inline-block';
        resetBtn.disabled = true;
    });
    
    function showToast(message, type) {
        const toastContainer = document.getElementById('toast-container');
        const toastId = 'toast-' + Date.now();
        
        const toastHtml = `
            <div class="toast show" id="${toastId}" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <i class="bi bi-${type === 'error' ? 'exclamation-triangle-fill text-danger' : 'check-circle-fill text-success'} me-2"></i>
                    <strong class="me-auto">${type === 'error' ? 'Error' : 'Success'}</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            </div>
        `;
        
        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            const toast = document.getElementById(toastId);
            if (toast) {
                const bsToast = new bootstrap.Toast(toast);
                bsToast.hide();
            }
        }, 5000);
    }
});
</script>
{% endblock %}
